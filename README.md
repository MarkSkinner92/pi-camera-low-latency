It all started four years ago when I was asked to make a low-latency video server for a robotics platform. I was very inexperienced and didn’t even know what a server was, haha. Anyway, I decided to use opencv to grab frames from /dev/video0, and push them as raw jpg over a socket.io connection to the browser where they would be rendered. It got the job done, but it was extremely strenuous on the network, and didn’t produce the best video. I had looked into WebRTC, and tried some things, but I just couldn’t get it to work.

I wrangled that system for a year, and then left for two years. When I came back, the embedded camera landscape had changed dramatically. There was now a “legacy” camera stack? What? I guess that’s the one I was using, but it wasn’t legacy at the time. There was a new library created called “libcamera.” It’s really cool, but it’s kinda new so there’s not much community support. I say kinda because it was released two years ago! Despite two years having gone by, and a desperate need for a better camera stack, there hasn’t been much done with it.

Libcamera does look super promising though. We really needed something like this that could pull the embedded camera community together under the same library.

I was super determined to make a webRTC implementation. I found a cool python library called “Aiortc.” It had an example webcam.py which opened a device's camera, and hosted a http server. Now, this was all fun and games on my windows machine, but when I put it on the Raspberry Pi, it didn’t work. Something was wrong with the way MediaPlayer opened /dev/video0, and I spent hours debugging that to no avail. I gave up and tried a different approach.

In my search for a different way to get the camera stream into aiortc, I stumbled across Mitant’s repo posted 4 months ago. https://github.com/mitant/aiortc-picamera2-webrtc It wasn’t documented, but It presented some interesting ideas related to capturing the pi camera, using picamera2. I found that picamera2 was a python wrapper for the new libcamera stack! How exciting! I tried out their code, and it didn’t work out of the box but  I could tell it was close. I had to take bits and pieces of it and mix it with webcam.py from Aiortc examples. To my surprise, it worked haha. It was a little stuttery, looking like 10fps or something. The latency was maybe 700ms. Really not great. I changed the camera to a V3. and saw slight improvement, but then it occurred to me that the camera was capturing at full resolution. I lowered it to 640x480, and it worked amazingly! The latency is less than 100ms, and there is no stutter in the stream at all. I am so delighted, and have big plans for future streaming projects!

A big thanks to Anthony Chen (Mitant) for doing most of the heavy lifting.
